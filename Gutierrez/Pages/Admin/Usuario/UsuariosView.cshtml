@page

@{
    Layout = "_LayoutAdmin";
}


<div class="content">
    <div class="top-controls">
        <div class="buttons-group">
            <button class="btn-green" id="AgregarUser">Agregar usuario</button>
        </div>
        <div class="search-container">
            <input type="text" placeholder="Buscar" class="search-input">
            <div class="search-icon">
                <i class="fas fa-search"></i>
            </div>
        </div>
    </div>
    <table class="data-table-p">
        <thead>
            <tr>
                <th>RFC</th>
                <th>Proveedor</th>
                <th>Usuario</th>
                <th>Estatus</th>
                <th>Acción</th> 
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>18273y273</td>
                <td>Nombre del proveedor</td>
                <td>Nombre de usuario</td>
                <td>BLOQUEAR</td>
                <td>
                    
                    <button class="delete-btn">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<script>
        document.addEventListener("DOMContentLoaded", () => {
        const tableBody = document.querySelector(".data-table-p tbody");

        // Función para llenar la tabla
        const fillTable = async () => {
            try {
                const response = await fetch("https://gutierrez.labsystec.net/api/Usuarios");
                if (!response.ok) {
                    throw new Error("Error al obtener los datos de la API");
                }
                else{
                    console.log("entro");
                }

                const usuarios = await response.json();

                // Limpiar el contenido existente de la tabla
                tableBody.innerHTML = "";

                // Renderizar los datos en la tabla
                usuarios.forEach((usuario) => {
                    const row = document.createElement("tr");

                    row.innerHTML = `
                        <td>${usuario.usuarioProveedor?.rfc || "N/A"}</td>
                        <td>${usuario.usuarioProveedor?.nombre || "N/A"}</td>
                        <td>${usuario.nombre}</td>
                        <td>
                            <button class="status-btn">${usuario.estatus ? "DESBLOQUEAR" : "BLOQUEAR"}</button>
                        </td>
                        <td>
                            <button class="delete-btn" data-id="${usuario.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    `;

                    tableBody.appendChild(row);
                });

                addEventListeners();
            } catch (error) {
                console.error("Error al llenar la tabla:", error);
            }
        };

        // Función para agregar event listeners a los botones de acción
        const addEventListeners = () => {
            document.querySelectorAll(".delete-btn").forEach((button) => {
                button.addEventListener("click", async (e) => {
                    const userId = e.target.closest("button").dataset.id;
                    if (confirm("¿Estás seguro de que deseas eliminar este usuario?")) {
                        try {
                            const response = await fetch(`https://gutierrez.labsystec.net/api/Usuarios/Eliminar/${userId}`, {
                                method: "DELETE",
                            });

                            if (response.ok) {
                                alert("Usuario eliminado exitosamente");
                                fillTable(); // Refrescar la tabla
                            } else {
                                throw new Error("Error al eliminar el usuario");
                            }
                        } catch (error) {
                            console.error("Error al eliminar el usuario:", error);
                            alert("No se pudo eliminar el usuario");
                        }
                    }
                });
            });

        };

        fillTable();
    });

</script>
<script>
 let UsuarioAdd = document.getElementById("AgregarUser").addEventListener("click", function () {
        window.location.replace("/Admin/Usuario/AgregarUsuario");
    });
</script>